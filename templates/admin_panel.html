{% extends "base.html" %}

{% block title %}{{ t.admin_title }}{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>{{ t.admin_title }}</h2>
        <a href="{{ url_for('admin_logout') }}" style="padding: 8px 16px; background-color: #6c757d; color: white; border-radius: 4px; text-decoration: none;">{{ t.logout }}</a>
    </div>
    
    <div style="margin-bottom: 20px;">
        <a href="{{ url_for('my_wishlist') }}" style="padding: 8px 16px; background-color: #007bff; color: white; border-radius: 4px; text-decoration: none;">{{ t.back_to_wishlist }}</a>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div style="padding: 10px; margin-bottom: 15px; border-radius: 5px; {% if category == 'success' %}background-color: #d4edda; color: #155724;{% else %}background-color: #f8d7da; color: #721c24;{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Reset section -->
    <h3 style="margin-top: 20px; color: #dc3545;">{{ t.reset_section }}</h3>
    <p style="color: #666; font-size: 0.9em;">{{ t.reset_desc }}</p>
    <form method="POST" action="{{ url_for('admin_reset') }}">
        <button type="submit" class="btn-danger" onclick="return confirm('{{ t.reset_confirm }}');">{{ t.reset_btn }}</button>
    </form>
    
    <!-- Wish Deadline section -->
    <h3 style="margin-top: 40px;">{{ t.wish_deadline_section }}</h3>
    <p style="color: #666; font-size: 0.9em;">{{ t.deadline_desc }}</p>
    <form method="POST" action="{{ url_for('set_deadline') }}">
        <label for="wish_deadline">{{ t.deadline_inclusive }}</label>
        <input type="date" id="wish_deadline" name="wish_deadline" value="{{ wish_deadline or '' }}"
               style="width: auto; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
        <button type="submit" class="btn-primary" style="margin-top: 10px;">{{ t.save_deadline }}</button>
    </form>
    {% if wish_deadline %}
    <p style="color: #666; margin-top: 5px;">
        {{ t.current_deadline }} <strong>{{ wish_deadline }}</strong>
    </p>
    {% else %}
    <p style="color: #666; font-style: italic; margin-top: 5px;">{{ t.no_deadline_set }}</p>
    {% endif %}

    <!-- Form to add a new family member -->
    <h3>{{ t.add_member }}</h3>
    <form method="POST" action="{{ url_for('add_family_member') }}">
        <label for="name">{{ t.member_name }}</label>
        <input type="text" id="name" name="name" required>

        <label for="team_name">{{ t.team_optional }}</label>
        <input type="text" id="team_name" name="team_name" placeholder="{{ t.no_team }}">
        
        <button type="submit" class="btn-primary">{{ t.add_member_btn }}</button>
    </form>

    <!-- Table displaying all family members -->
    <h3>{{ t.family_pool }}</h3>
    {% if family_members %}
    <table>
        <thead>
            <tr>
                <th>{{ t.name_col }}</th>
                <th>{{ t.team_col }}</th>
                <th>{{ t.actions_col }}</th>
            </tr>
        </thead>
        <tbody>
            {% for member in family_members %}
            {# Define the edit form outside the table cells so inputs can reference it via the form attribute #}
            <form id="edit-member-{{ member.id }}" method="POST" action="{{ url_for('edit_family_member', member_id=member.id) }}"></form>
            <tr>
                <td>
                    <input form="edit-member-{{ member.id }}" type="text" name="name" value="{{ member.name }}" style="width: 180px;">
                </td>
                <td>
                    <input form="edit-member-{{ member.id }}" type="text" name="team_name" value="{{ member.team_name or '' }}" placeholder="{{ t.no_team }}" style="width: 150px;">
                </td>
                <td>
                    <button form="edit-member-{{ member.id }}" type="submit" class="btn-primary" style="font-size: 12px; padding: 5px 10px;">{{ t.update_btn }}</button>
                    <form method="POST" action="{{ url_for('delete_family_member', member_id=member.id) }}" style="display: inline;">
                        <button type="submit" class="btn-delete" onclick="return confirm('{{ t.delete_member_confirm }} {{ member.name }}.');">{{ t.delete }}</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #666; margin: 40px 0;">
        {{ t.no_members_yet }}
    </p>
    {% endif %}

    <!-- Secret Santa section -->
    <h3 style="margin-top: 40px;">{{ t.secret_santa_admin }}</h3>
    <form method="POST" action="{{ url_for('run_secret_santa') }}" style="margin-bottom: 20px;">
        <button type="submit" class="btn-primary" onclick="return confirm('{{ t.run_ss_confirm }}');">{{ t.run_ss }}</button>
    </form>
    {% if secret_santa %}
    <table>
        <thead>
            <tr>
                <th>{{ t.giver }}</th>
                <th>{{ t.receiver }}</th>
            </tr>
        </thead>
        <tbody>
            {% for assignment in secret_santa %}
            <tr>
                <td>{{ assignment.giver_name }}</td>
                <td>{{ assignment.receiver_name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666; font-style: italic;">{{ t.no_ss }}</p>
    {% endif %}

    <!-- All wishes table -->
    <h3 style="margin-top: 40px;">{{ t.all_wishes }}</h3>
    {% if all_wishes %}
    <table>
        <thead>
            <tr>
                <th>{{ t.person_col }}</th>
                <th>{{ t.wish_col }}</th>
                <th>{{ t.product_col }}</th>
                <th>{{ t.actions_col }}</th>
            </tr>
        </thead>
        <tbody>
            {% for wish in all_wishes %}
            <tr>
                <td>{{ wish.person_name }}</td>
                <td>{{ wish.wish_text | nl2br }}</td>
                <td>
                    {% if wish.product_link %}
                        <a href="{{ wish.product_link }}" target="_blank">{{ t.view_product }}</a>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <form method="POST" action="{{ url_for('delete_wish', wish_id=wish.id) }}" style="display: inline;">
                        <button type="submit" class="btn-delete" onclick="return confirm('{{ t.delete_wish_confirm }}');">{{ t.delete }}</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: #666; font-style: italic;">{{ t.no_wishes_admin }}</p>
    {% endif %}
{% endblock %}
